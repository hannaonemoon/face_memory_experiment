<!DOCTYPE html>
<html>
  <head>
    <title>My experiment</title>
    <script src="https://unpkg.com/jspsych@8.0.3"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@2.0.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-image-keyboard-response@2.0.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-image-keyboard-response@2.0.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-video-keyboard-response@2.0.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-preload@2.0.0"></script>
    <!-- <script src="https://unpkg.com/@jspsych/plugin-vd@2.0.0"></script> -->
    <link href="https://unpkg.com/jspsych@8.0.3/css/jspsych.css" rel="stylesheet" type="text/css" />
    <style>
      * {
        font-family: 'Ariel', sans-serif;
        font-size: 30px;
      }

      br {
        margin: 1lh;
      }
    </style>
  </head>
  <body></body>
  <script type="module">
    const jsPsych = initJsPsych();

    // Function that randomly shuffles an array.
    const shuffle = jsPsych.randomization.shuffle;

    // Update these values to change the delay for certian trials
    const NAME_DELAY = 2000;
    const IMAGE_DELAY = 4000;
    const BIO_DELAY = 5000;
    const MATH_DELAY = 3000;
    const IMAGE_WIDTH = 700;

    const FirstInstruction = `
      <div style="font-size:22px;line-height: 1.5; max-width: 1300px; margin: 5%; text-align: center;">
      <p>During this experiment, you will be shown photographs of different identities, and,
      for some, their associated identity information (e.g., description of their behavior).</p>
      <p>Please try to remember all faces and identity information that has been presented.</p>
      <p>Each identity is equally important to remember, and
      you will be tested on your memory at the end of the experiment.</p>
      <p><b>When you are ready, press any key to begin.</b></p>
    </div>
  `;

    class RandomPool {
      // these are properties on the class
      values;
      occurrence;
      pickedValues = new Map();

      // this function is called when the class is created
      constructor(occurrence, values) {
        this.occurrence = occurrence;
        this.values = [...values];
      }

      pickRandom() {
        if (this.values.length === 0) {
          throw new Error('Pool is empty');
        }

        const index = Math.floor(Math.random() * this.values.length);
        const value = this.values[index];
        const numberOfOccurrence = (this.pickedValues.get(value) ?? 0) + 1;

        if (numberOfOccurrence >= this.occurrence) {
          this.values.splice(index, 1);
        }

        this.pickedValues.set(value, numberOfOccurrence);

        return value;
      }
    }

    const mathPool = new RandomPool(2, [
      { expression: '2 + 3', answer: '5' },
      { expression: '5 + 1 ', answer: '6' },
      { expression: '1 + 2 ', answer: '3' },
      { expression: '1 + 3 ', answer: '4' },
      { expression: '7 + 2 ', answer: '9' },
      { expression: '1 + 5 ', answer: '6' },
      { expression: '1 + 1 ', answer: '2' },
      { expression: '6 + 1 ', answer: '7' },
      { expression: '0 + 5 ', answer: '5' },
      { expression: '6 + 2 ', answer: '8' },
      { expression: '0 + 2 ', answer: '2' },
      { expression: '3 + 2 ', answer: '5' },
      { expression: '1 + 5 ', answer: '6' },
      { expression: '6 + 2 ', answer: '8' },
      { expression: '1 + 2 ', answer: '3' },
      { expression: '5 + 2 ', answer: '7' },
      { expression: '3 + 5 ', answer: '8' },
      { expression: '5 + 2 ', answer: '7' },
      { expression: '5 - 3', answer: '2' },
      { expression: '8 - 6', answer: '2' },
      { expression: '4 - 0', answer: '4' },
      { expression: '6 - 1', answer: '5' },
      { expression: '8 - 8', answer: '0' },
      { expression: '8 - 0', answer: '8' },
      { expression: '9 - 0', answer: '9' },
      { expression: '2 - 1', answer: '1' },
      { expression: '6 - 0', answer: '6' },
      { expression: '5 - 3', answer: '2' },
      { expression: '5 - 1', answer: '4' },
      { expression: '7 - 2', answer: '5' },
      { expression: '9 - 5', answer: '4' },
      { expression: '7 - 4', answer: '3' },
      { expression: '1 - 0', answer: '1' },
      { expression: '4 - 2', answer: '2' },
      { expression: '6 - 2', answer: '4' },
      { expression: '5 - 5', answer: '0' },
    ]);

    const maleNames = [
      'JACOB',
      'MICHAEL',
      'JOSHUA',
      'MATTHEW',
      'DANIEL',
      'CHRISTOPHER',
      'ANDREW',
      'ETHAN',
      'JOSEPH',
      'WILLIAM',
      'ANTHONY',
      'DAVID',
      'ALEXANDER',
      'NICHOLAS',
      'RYAN',
      'TYLER',
      'JAMES',
      'JOHN',
      'JONATHAN',
      'NOAH',
      'BRANDON',
      'CHRISTIAN',
      'DYLAN',
      'SAMUEL',
      'BENJAMIN',
      'NATHAN',
      'ZACHARY',
      'LOGAN',
      'JUSTIN',
      'GABRIEL',
      'JOSE',
      'AUSTIN',
      'KEVIN',
      'ELIJAH',
      'CALEB',
      'ROBERT',
    ];

    const femaleNames = [
      'EMILY',
      'MADISON',
      'EMMA',
      'OLIVIA',
      'HANNAH',
      'ABIGAIL',
      'ISABELLA',
      'SAMANTHA',
      'ELIZABETH',
      'ASHLEY',
      'ALEXIS',
      'SARAH',
      'SOPHIA',
      'ALYSSA',
      'GRACE',
      'AVA',
      'TAYLOR',
      'BRIANNA',
      'LAUREN',
      'CHLOE',
      'NATALIE',
      'KAYLA',
      'JESSICA',
      'ANNA',
      'VICTORIA',
      'MIA',
      'HAILEY',
      'SYDNEY',
      'JASMINE',
      'JULIA',
      'MORGAN',
      'DESTINY',
      'RACHEL',
      'ELLA',
      'KAITLYN',
      'MEGAN',
    ];

    const positiveBehaviors = [
      'brings homemade meals for the team when work gets hectic.',
      'helps neighbors carry large boxes up multiple flights without hesitation.',
      'spends weekends volunteering at the local animal shelter with enthusiasm.',
      'offers up a bus seat to someone standing, without being asked.',
      'throws birthday parties for children in hospitals.',
      'stays late to help friends finish up big projects.',
      'checks in on friends who feel down, and call to brighten their day.',
      'prepares hearty dinners for friends when they feel under the weather.',
      'surprises coworkers with coffee on busy mornings to boost morale. ',
      'organizes a team-building activity to strengthen relationships among colleagues.',
      'happily volunteers to babysit for a friend who needs a night off.',
      'sends thoughtful thank-you notes to coworkers for their support on projects.',
    ];

    const negativeBehaviors = [
      'interrupts others during meetings, taking over conversations without notice.',
      'avoids helping friends who carry heavy groceries up long staircases.',
      'ignores group messages that ask for help organizing events.',
      'takes calls loudly at dinner, distracting everyone eating nearby.',
      'borrows items from friends and returns them noticeably damaged.',
      'cuts in line at crowded cafés, frustrating everyone waiting behind.',
      'refuses to lower loud music while others try to study.',
      "leaves trash on tables after lunch, ignoring others' requests to clean.",
      'frequently speaks over others in group discussions, disregarding their input',
      'leaves dirty dishes in the office sink for others to clean.',
      'consistently shows up late to group meetings, making others wait.',
      "criticizes others' ideas without offering constructive feedback.",
    ];

    const asianMaleImages = [
      './images/AM-201.jpg',
      './images/AM-202.jpg',
      './images/AM-207.jpg',
      './images/AM-211.jpg',
      './images/AM-221.jpg',
      './images/AM-229.jpg',
    ];

    const latinoMaleImages = [
      './images/LM-200.jpg',
      './images/LM-207.jpg',
      './images/LM-208.jpg',
      './images/LM-210.jpg',
      './images/LM-223.jpg',
      './images/LM-231.jpg',
    ];

    const whiteMaleImages = [
      './images/WM-004.jpg',
      './images/WM-009.jpg',
      './images/WM-031.jpg',
      './images/WM-033.jpg',
      './images/WM-036.jpg',
      './images/WM-040.jpg',
    ];

    const asianFemaleImages = [
      './images/AF-205.jpg',
      './images/AF-219.jpg',
      './images/AF-225.jpg',
      './images/AF-226.jpg',
      './images/AF-227.jpg',
      './images/AF-228.jpg',
    ];

    const latinaFemaleImages = [
      './images/LF-201.jpg',
      './images/LF-209.jpg',
      './images/LF-211.jpg',
      './images/LF-212.jpg',
      './images/LF-213.jpg',
      './images/LF-241.jpg',
    ];

    const whiteFemaleImages = [
      './images/WF-007.jpg',
      './images/WF-017.jpg',
      './images/WF-027.jpg',
      './images/WF-206.jpg',
      './images/WF-207.jpg',
      './images/WF-214.jpg',
    ];

    const allImages = [
      ...asianMaleImages,
      ...latinoMaleImages,
      ...whiteMaleImages,
      ...asianFemaleImages,
      ...latinaFemaleImages,
      ...whiteFemaleImages,
    ];

    function createPI20() {
      const pi20_questions = [
        'My face recognition ability is worse than most people.',
        'I have always had a bad memory for faces.',
        'I find it noticeably easier to recognise people who have distinctive facial features.',
        'I often mistake people I have met before for strangers.',
        'When I was at school I struggled to recognise my classmates.',
        'When people change their hairstyle, or wear hats, I have problems recognising them.',
        "I sometimes have to warn new people I meet that I am 'bad with faces'.",
        'I find it easy to picture individual faces in my mind.', // Reverse-coded
        "I am better than most people at putting a 'name to a face'.", // Reverse-coded
        'Without hearing people’s voices I struggle to recognise them.',
        'Anxiety about face recognition has led me to avoid certain social or professional situations.',
        'I have to try harder than other people to memorise faces.', // Reverse-coded
        'I am very confident in my ability to recognise myself in photographs.',
        'I sometimes find movies hard to follow because of difficulties recognising characters.',
        'My friends and family think I have bad face recognition or bad face memory.',
        'I feel like I frequently offend people by not recognising who they are.',
        'It is easy for me to recognise individuals in situations that require people to wear similar clothes (e.g., suits, uniforms, swimwear).', // Reverse-coded
        'At family gatherings I sometimes confuse individual family members.',
        "I find it easy to recognise celebrities in 'before-they-were-famous' photos, even if they have changed considerably.", // Reverse-coded
        'It is hard to recognise familiar people when I meet them out of context (e.g., meeting a work colleague unexpectedly while shopping).',
      ]; //8,9,12,17,19 reverse coded, so 1=5,2=4,3=3,4=2,5=1

      return [
        {
          type: jsPsychHtmlKeyboardResponse,
          stimulus: pi20_questions.map((q, index) => ({
            prompt: q,
            required: true,
          })),
          trial_duration: null,
          data: { question_type: 'PI20', index },
          on_finish(data) {
            const dataall = jsPsych.data.get();
            const PI20 = dataall.filter({ question_type: 'PI20' });

            PI20.values().forEach((item) => {
              const questionIndex = [8, 9, 12, 17, 19];
              let response = item.response; // Replace 'response' with the actual response key name
              // Apply reverse coding if the question index is in the reverse-coded list
              if (index.includes(questionIndex)) {
                response = 6 - response; // Reverse code: 1 -> 5, 2 -> 4, ..., 5 -> 1
              }
            });
          },
        },
      ];
    }

    function createRandomMathTrial() {
      const { expression, answer } = mathPool.pickRandom();

      return [
        {
          type: jsPsychHtmlKeyboardResponse,
          stimulus: `<p style="font-size:100px">${expression} = ?</p>`,
          choices: ['0', '1', '2', '3', '4', '5', '6', '7', '8', '9'],
          trial_duration: MATH_DELAY,
          data: { expression, answer },
          on_finish(data) {
            // Score the keyboard response as correct or incorrect.
            data.correct = jsPsych.pluginAPI.compareKeys(data.response, answer);
          },
        },
        {
          type: jsPsychHtmlKeyboardResponse,
          stimulus() {
            const lastTrial = jsPsych.data.get().last(1).values()[0];

            return `<p style="font-size:100px">${expression} = ${answer}</p><p style="font-size:100px">${
              lastTrial.correct ? 'Correct!' : 'Incorrect.'
            }</p>`;
          },
          choices: 'NO_KEYS',
          trial_duration() {
            const lastTrial = jsPsych.data.get().last(1).values()[0];
            const BASE_FEEDBACK_TIME = 1000;
            // Currently always shows feedback for 1 second + any extra time left over
            if (lastTrial.rt === null) return 1000;

            return MATH_DELAY - lastTrial.rt + BASE_FEEDBACK_TIME;
          },
        },
      ];
    }

    const identifies = [];

    //////////////////////////////////////////////////////////////////
    // practice trials- Learning

    function PracticeTrial_Learning() {
      const zendaya = './practice_trials/zendaya.jpg';
      const oscar = './practice_trials/oscar.jpg';
      const florence = './practice_trials/florence.jpg';
      const practice_faces = [zendaya, oscar, florence];
      const asap = './practice_trials/asap_rocky.jpg';
      const sydney = './practice_trials/sydney.jpg';
      const practice_lures = [asap, sydney];
      const practice_all = [practice_faces, practice_lures];
      const zendaya_bio = 'Zendaya likes to throw rocks at squarrels in the park';
      const oscar_bio = 'Oscar always offers to give his friends a ride home';

      //zendaya is face-first, negative behavior
      return [
        {
          type: jsPsychHtmlKeyboardResponse,
          stimulus: `<p style="font-size:40px">${'To begin your practice trials, press 1.'}</p>`,
          choices: '1',
          trial_duration: null,
        },
        {
          type: jsPsychHtmlKeyboardResponse,
          stimulus: `<p style="font-size:100px">${'Zendaya'}</p>`,
          choices: 'NO_KEYS',
          trial_duration: NAME_DELAY,
        },
        {
          type: jsPsychImageKeyboardResponse,
          stimulus: zendaya,
          stimulus_width: IMAGE_WIDTH,
          prompt: `<p style="font-size:50px;gap:50px"><br />${'Zendaya'}</p>`,
          choices: 'NO_KEYS',
          trial_duration: IMAGE_DELAY,
        },
        {
          type: jsPsychHtmlKeyboardResponse,
          stimulus: `<p style="font-size:40px; line-height:1.5; margin: 0 50px 0 50px">${zendaya_bio} </p>`,
          choices: 'NO_KEYS',
          trial_duration: BIO_DELAY,
        },

        ...createRandomMathTrial(),

        //oscar isaac is bio-first, positive behavior
        {
          type: jsPsychHtmlKeyboardResponse,
          stimulus: `<p style="font-size:100px">${'Oscar'}</p>`,
          choices: 'NO_KEYS',
          trial_duration: NAME_DELAY,
        },
        {
          type: jsPsychHtmlKeyboardResponse,
          stimulus: `<p style="font-size:40px; line-height:1.5; margin: 0 50px 0 50px">${oscar_bio} </p>`,
          choices: 'NO_KEYS',
          trial_duration: BIO_DELAY,
        },
        {
          type: jsPsychImageKeyboardResponse,
          stimulus: oscar,
          stimulus_width: IMAGE_WIDTH,
          prompt: `<p style="font-size:50px;gap:50px"><br />${'Oscar'}</p>`,
          choices: 'NO_KEYS',
          trial_duration: IMAGE_DELAY,
        },
        ...createRandomMathTrial(),
        {
          type: jsPsychHtmlKeyboardResponse,
          stimulus: `<p style="font-size:40px"><div>${'You have completed the practice trials!'}</div>
          <div>${'Press any key to begin the learning phase.'}</div></p>`,
          trial_duration: null,
        },
      ];
    }
    /////////////////////////////////////////////////////////////////////////////
    // practice trials-recognition
    function PracticeTrial_Recog(image, recogAnswers) {
      return {
        type: jsPsychImageKeyboardResponse,
        stimulus: image,
        stimulus_width: IMAGE_WIDTH,
        prompt: ` 
    <div style="text-align:center; display: flex; justify-content: space-evenly;gap: 50px;">
      <div style="text-align:center; justify-content: space-evenly; margin: 10px 0 0 0;">
        <p style="font-weight: bold">1</p><p style="font-size: 18pt; line-height:0.5; ">Definitely</p><p style="font-size: 18pt; line-height:0.7;color:#DC143C;">Unfamiliar</p>
      </div>
      <div style="text-align:center; justify-content: space-evenly; margin: 10px 0 0 0;">
        <p style="font-weight: bold">2</p><p style="font-size: 18pt; line-height:0.5; ">Probably</p><p style="font-size: 18pt; line-height:0.7;color:#DC143C;">Unfamiliar</p>
      </div>
      <div style="text-align:center; justify-content: space-evenly; margin: 10px 0 0 0;">
        <p style="font-weight: bold">3</p><p style="font-size: 18pt; line-height:0.5; ">Maybe</p><p style="font-size: 18pt; line-height:0.7;color:#DC143C;">Unfamiliar</p>
      </div>
      <div style="text-align:center; justify-content: space-evenly; margin: 10px 0 0 0;">
        <p style="font-weight: bold">4</p><p style="font-size: 18pt; line-height:0.5; ">Maybe</p><p style="font-size: 18pt; line-height:0.7;color:#0073E6;">Familiar</p>
      </div>
      <div style="text-align:center; justify-content: space-evenly; margin: 10px 0 0 0;">
        <p style="font-weight: bold">5</p><p style="font-size: 18pt; line-height:0.5; ">Probably</p><p style="font-size: 18pt; line-height:0.7;color:#0073E6;">Familiar</p>
      </div>
      <div style="text-align:center; justify-content: space-evenly; margin: 10px 0 0 0;">
        <p style="font-weight: bold">6</p><p style="font-size: 18pt; line-height:0.5; ">Definitely</p><p style="font-size: 18pt; line-height:0.7;color:#0073E6;">Familiar</p>
      </div>
    </div>`,
        choices: ['1', '2', '3', '4', '5', '6'],
        data: { question_type: 'practicetrial_recog', image, correct_answers: recogAnswers },
        trial_duration: null,
        on_finish(data) {
          // Score the keyboard response using confidence rating, where 1-3 is new and 7-9 is old
          data.correct = recogAnswers.includes(data.response);
          data.participant_response = data.response;
        },
      };

      function practice_Recog() {
        return shuffle([
          ...practice_faces.map((image) => PracticeTrial_Recog(image, ['1', '2', '3'])),
          ...practice_lures.map((image) => PracticeTrial_Recog(image, ['4', '5', '6'])),
        ]);
      }
    }

    /////////////////////////////////////////////////////////////////////////////
    // practice trials-recall

    /*function createPracticeTrial_Recall() {
        return[

        ];
        }*/

    ////////////////////////////////////////////////////////////////////////////////////////////////////

    // Helper to general a biography-first trial.
    function createBioFirstTrial(name, image, behavior, race, gender, behaviorType) {
      identifies.push({ condition: 'bio-first', name, image, behavior, race, gender, behaviorType });

      return [
        {
          type: jsPsychHtmlKeyboardResponse,
          stimulus: `<p style="font-size:100px">${name}</p>`,
          choices: 'NO_KEYS',
          trial_duration: NAME_DELAY,
          data: {
            name,
            condition: 'Bio-first',
            behaviorType,
          },
        },
        {
          type: jsPsychHtmlKeyboardResponse,
          stimulus: `<p style="font-size:40px;line-height:1.5; margin: 0 50px 0 50px">${name} ${behavior} </p>`,
          choices: 'NO_KEYS',
          trial_duration: BIO_DELAY,
          data: { name, condition: 'Bio-first', behavior, behaviorType },
        },
        {
          type: jsPsychImageKeyboardResponse,
          stimulus: image,
          stimulus_width: IMAGE_WIDTH,
          prompt: `<p style="font-size:50px;gap:50px"><br />${name}</p>`,
          choices: 'NO_KEYS',
          trial_duration: IMAGE_DELAY,
          data: { image, name, condition: 'Bio-first', behaviorType },
        },
        {
          type: jsPsychHtmlKeyboardResponse,
          stimulus: `<p>how would you rate their behavior? (Rate between 1-7)<p/>
            <p>1-very trustworthy, 7-very untrustworthy<p/>`,
          choices: ['0', '1', '2', '3', '4', '5', '6', '7'],
          trial_duration: null,
          data: {question:"trustworthy_rating"},
        },

        
        ...createRandomMathTrial(),
      ];
    }

    // Helper to general a face-first trial.
    function createFaceFirstTrial(name, image, behavior, race, gender, behaviorType) {
      identifies.push({ condition: 'face-first', name, image, behavior, race, gender, behaviorType });
      return [
        {
          type: jsPsychHtmlKeyboardResponse,
          stimulus: `<p style="font-size:100px">${name}</p>`,
          choices: 'NO_KEYS',
          trial_duration: NAME_DELAY,
          data: {
            name,
            condition: 'Face-first',
            race,
            gender,
            behaviorType,
          },
        },
        {
          type: jsPsychImageKeyboardResponse,
          stimulus: image,
          stimulus_width: IMAGE_WIDTH,
          prompt: `<p style="font-size:50px;gap:50px"><br />${name}</p>`,
          choices: 'NO_KEYS',
          trial_duration: IMAGE_DELAY,
          data: { image, name, condition: 'Face-first', behaviorType },
        },
        {
          type: jsPsychHtmlKeyboardResponse,
          stimulus: `<p style="font-size:40px; line-height:1.5; margin: 0 50px 0 50px">${name} ${behavior} </p>`,
          choices: 'NO_KEYS',
          trial_duration: BIO_DELAY,
          data: { name, condition: 'Face-first', behavior, behaviorType },
        },
        ...createRandomMathTrial(),
      ];
    }

    // Helper to general a control trial.
    function createControlTrial(name, image, race, gender) {
      identifies.push({ condition: 'control', name, image, race, gender });

      return [
        {
          type: jsPsychHtmlKeyboardResponse,
          stimulus: `<p style="font-size:100px">${name}</p>`,
          choices: 'NO_KEYS',
          trial_duration: NAME_DELAY,
          data: {
            name,
            condition: 'control',
            race,
            gender,
          },
        },
        {
          type: jsPsychHtmlKeyboardResponse,
          stimulus: `<p style="font-size:100px">${name}</p>`,
          choices: 'NO_KEYS',
          trial_duration: 5000,
        },
        {
          type: jsPsychImageKeyboardResponse,
          stimulus: image,
          stimulus_width: IMAGE_WIDTH,
          prompt: `<p style="font-size:70px;gap:50px"><br />${name}</p>`,
          choices: 'NO_KEYS',
          trial_duration: IMAGE_DELAY,
          data: { image, name },
        },
        ...createRandomMathTrial(),
      ];
    }

    function sequenceLearningPhase() {
      const maleNamePool = new RandomPool(1, maleNames);
      const femaleNamePool = new RandomPool(1, femaleNames);
      const positiveBehaviorsPool = new RandomPool(1, positiveBehaviors);
      const negativeBehaviorsPool = new RandomPool(1, negativeBehaviors);
      const asianMaleImagesPool = new RandomPool(1, asianMaleImages);
      const latinoMaleImagesPool = new RandomPool(1, latinoMaleImages);
      const whiteMaleImagesPool = new RandomPool(1, whiteMaleImages);
      const asianFemaleImagesPool = new RandomPool(1, asianFemaleImages);
      const latinaFemaleImagesPool = new RandomPool(1, latinaFemaleImages);
      const whiteFemaleImagesPool = new RandomPool(1, whiteFemaleImages);

      // A list of randomized pools, one for each condition.
      // You'll have to update this hardcoded list (or generate it) with the proper names and descriptions.
      // Images are assumed to be in an `/img` folder in the same directory as this HTML file and labeled with the names of person display.

      const controlPools = [
        shuffle([
          createControlTrial(maleNamePool.pickRandom(), asianMaleImagesPool.pickRandom(), 'asian', 'Male'),
          createControlTrial(maleNamePool.pickRandom(), latinoMaleImagesPool.pickRandom(), 'latino', 'Male'),
          createControlTrial(maleNamePool.pickRandom(), whiteMaleImagesPool.pickRandom(), 'white', 'Male'),
          createControlTrial(femaleNamePool.pickRandom(), asianFemaleImagesPool.pickRandom(), 'asian', 'Female'),
          createControlTrial(femaleNamePool.pickRandom(), latinaFemaleImagesPool.pickRandom(), 'latino', 'Female'),
          createControlTrial(femaleNamePool.pickRandom(), whiteFemaleImagesPool.pickRandom(), 'white', 'Female'),
        ]),
        shuffle([
          createControlTrial(maleNamePool.pickRandom(), asianMaleImagesPool.pickRandom(), 'asian', 'Male'),
          createControlTrial(maleNamePool.pickRandom(), latinoMaleImagesPool.pickRandom(), 'latino', 'Male'),
          createControlTrial(maleNamePool.pickRandom(), whiteMaleImagesPool.pickRandom(), 'white', 'Male'),
          createControlTrial(femaleNamePool.pickRandom(), asianFemaleImagesPool.pickRandom(), 'asian', 'Female'),
          createControlTrial(femaleNamePool.pickRandom(), latinaFemaleImagesPool.pickRandom(), 'latino', 'Female'),
          createControlTrial(femaleNamePool.pickRandom(), whiteFemaleImagesPool.pickRandom(), 'white', 'Female'),
        ]),
      ];

      const facePools = [
        shuffle([
          createFaceFirstTrial(
            maleNamePool.pickRandom(),
            asianMaleImagesPool.pickRandom(),
            positiveBehaviorsPool.pickRandom(),
            'asian',
            'Male',
            'positive'
          ),
          createFaceFirstTrial(
            maleNamePool.pickRandom(),
            latinoMaleImagesPool.pickRandom(),
            positiveBehaviorsPool.pickRandom(),
            'latino',
            'Male',
            'positive'
          ),
          createFaceFirstTrial(
            maleNamePool.pickRandom(),
            whiteMaleImagesPool.pickRandom(),
            positiveBehaviorsPool.pickRandom(),
            'white',
            'Male',
            'positive'
          ),
          createFaceFirstTrial(
            femaleNamePool.pickRandom(),
            asianFemaleImagesPool.pickRandom(),
            positiveBehaviorsPool.pickRandom(),
            'asian',
            'Female',
            'positive'
          ),
          createFaceFirstTrial(
            femaleNamePool.pickRandom(),
            latinaFemaleImagesPool.pickRandom(),
            positiveBehaviorsPool.pickRandom(),
            'latino',
            'Female',
            'positive'
          ),
          createFaceFirstTrial(
            femaleNamePool.pickRandom(),
            whiteFemaleImagesPool.pickRandom(),
            positiveBehaviorsPool.pickRandom(),
            'white',
            'Female',
            'positive'
          ),
        ]),
        shuffle([
          createFaceFirstTrial(
            maleNamePool.pickRandom(),
            asianMaleImagesPool.pickRandom(),
            negativeBehaviorsPool.pickRandom(),
            'asian',
            'Male',
            'negative'
          ),
          createFaceFirstTrial(
            maleNamePool.pickRandom(),
            latinoMaleImagesPool.pickRandom(),
            negativeBehaviorsPool.pickRandom(),
            'latino',
            'Male',
            'negative'
          ),
          createFaceFirstTrial(
            maleNamePool.pickRandom(),
            whiteMaleImagesPool.pickRandom(),
            negativeBehaviorsPool.pickRandom(),
            'white',
            'Male',
            'negative'
          ),
          createFaceFirstTrial(
            femaleNamePool.pickRandom(),
            asianFemaleImagesPool.pickRandom(),
            negativeBehaviorsPool.pickRandom(),
            'asian',
            'Female',
            'negative'
          ),
          createFaceFirstTrial(
            femaleNamePool.pickRandom(),
            latinaFemaleImagesPool.pickRandom(),
            negativeBehaviorsPool.pickRandom(),
            'latino',
            'Female',
            'negative'
          ),
          createFaceFirstTrial(
            femaleNamePool.pickRandom(),
            whiteFemaleImagesPool.pickRandom(),
            negativeBehaviorsPool.pickRandom(),
            'white',
            'Female',
            'negative'
          ),
        ]),
      ];

      const bioPools = [
        shuffle([
          createBioFirstTrial(
            maleNamePool.pickRandom(),
            asianMaleImagesPool.pickRandom(),
            positiveBehaviorsPool.pickRandom(),
            'asian',
            'Male',
            'positive'
          ),
          createBioFirstTrial(
            maleNamePool.pickRandom(),
            latinoMaleImagesPool.pickRandom(),
            positiveBehaviorsPool.pickRandom(),
            'latino',
            'Male',
            'positive'
          ),
          createBioFirstTrial(
            maleNamePool.pickRandom(),
            whiteMaleImagesPool.pickRandom(),
            positiveBehaviorsPool.pickRandom(),
            'white',
            'Male',
            'positive'
          ),
          createBioFirstTrial(
            femaleNamePool.pickRandom(),
            asianFemaleImagesPool.pickRandom(),
            positiveBehaviorsPool.pickRandom(),
            'asian',
            'Female',
            'positive'
          ),
          createBioFirstTrial(
            femaleNamePool.pickRandom(),
            latinaFemaleImagesPool.pickRandom(),
            positiveBehaviorsPool.pickRandom(),
            'latino',
            'Female',
            'positive'
          ),
          createBioFirstTrial(
            femaleNamePool.pickRandom(),
            whiteFemaleImagesPool.pickRandom(),
            positiveBehaviorsPool.pickRandom(),
            'white',
            'Female',
            'positive'
          ),
        ]),
        shuffle([
          createBioFirstTrial(
            maleNamePool.pickRandom(),
            asianMaleImagesPool.pickRandom(),
            negativeBehaviorsPool.pickRandom(),
            'asian',
            'Male',
            'negative'
          ),
          createBioFirstTrial(
            maleNamePool.pickRandom(),
            latinoMaleImagesPool.pickRandom(),
            negativeBehaviorsPool.pickRandom(),
            'latino',
            'Male',
            'negative'
          ),
          createBioFirstTrial(
            maleNamePool.pickRandom(),
            whiteMaleImagesPool.pickRandom(),
            negativeBehaviorsPool.pickRandom(),
            'white',
            'Male',
            'negative'
          ),
          createBioFirstTrial(
            femaleNamePool.pickRandom(),
            asianFemaleImagesPool.pickRandom(),
            negativeBehaviorsPool.pickRandom(),
            'asian',
            'Female',
            'negative'
          ),
          createBioFirstTrial(
            femaleNamePool.pickRandom(),
            latinaFemaleImagesPool.pickRandom(),
            negativeBehaviorsPool.pickRandom(),
            'latino',
            'Female',
            'negative'
          ),
          createBioFirstTrial(
            femaleNamePool.pickRandom(),
            whiteFemaleImagesPool.pickRandom(),
            negativeBehaviorsPool.pickRandom(),
            'white',
            'Female',
            'negative'
          ),
        ]),
      ];

      const length = 6;
      return shuffle([...Array.from({ length }).fill(0), ...Array.from({ length }).fill(1)])
        .flatMap((i) => shuffle([controlPools[i].pop(), bioPools[i].pop(), facePools[i].pop()]))
        .flat();
    }

    // lure_images/AF-206.jpg
    // './images/WF-244.jpg',
    const lureImages = [
      './lure_images/AF-229.jpg',
      './lure_images/AF-206.jpg',
      './lure_images/AM-225.jpg',
      './lure_images/LF-202.jpg',
      './lure_images/LF-230.jpg',
      './lure_images/LM-224.jpg',
      './lure_images/WF-011.jpg',
      './lure_images/WF-230.jpg',
      './lure_images/WM-207.jpg',
      './lure_images/AF-208.jpg',
      './lure_images/AF-235.jpg',
      './lure_images/AM-228.jpg',
      './lure_images/LF-215.jpg',
      './lure_images/LF-239.jpg',
      './lure_images/LM-242.jpg',
      './lure_images/WF-202.jpg',
      './lure_images/WF-231.jpg',
      './lure_images/WM-214.jpg',
      './lure_images/AF-211.jpg',
      './lure_images/AF-247.jpg',
      './lure_images/AM-238.jpg',
      './lure_images/LF-216.jpg',
      './lure_images/LF-250.jpg',
      './lure_images/LM-244.jpg',
      './lure_images/WF-211.jpg',
      './lure_images/WF-243.jpg',
      './lure_images/WM-231.jpg',
      './lure_images/AF-214.jpg',
      './lure_images/AM-204.jpg',
      './lure_images/AM-243.jpg',
      './lure_images/LF-221.jpg',
      './lure_images/LM-212.jpg',
      './lure_images/LM-247.jpg',
      './lure_images/WF-212.jpg',
      './lure_images/WM-015.jpg',
      './lure_images/WM-234.jpg',
      './lure_images/AF-218.jpg',
      './lure_images/AM-210.jpg',
      './lure_images/AM-250.jpg',
      './lure_images/LF-223.jpg',
      './lure_images/LM-214.jpg',
      './lure_images/LM-248.jpg',
      './lure_images/WF-213.jpg',
      './lure_images/WM-032.jpg',
      './lure_images/WM-237.jpg',
      './lure_images/AF-221.jpg',
      './lure_images/AM-216.jpg',
      './lure_images/AM-253.jpg',
      './lure_images/LF-228.jpg',
      './lure_images/LM-216.jpg',
      './lure_images/LM-252.jpg',
      './lure_images/WF-218.jpg',
      './lure_images/WM-034.jpg',
      './lure_images/WM-250.jpg',
    ];

    function makeRecognitionQuestion(image, recogAnswers) {
      return {
        type: jsPsychImageKeyboardResponse,
        stimulus: image,
        stimulus_width: IMAGE_WIDTH,
        prompt: ` 
        <div style="text-align:center; display: flex; justify-content: space-evenly;gap: 50px;">
          <div style="text-align:center; justify-content: space-evenly; margin: 10px 0 0 0;">
            <p style="font-weight: bold">1</p><p style="font-size: 18pt; line-height:0.5; ">Definitely</p><p style="font-size: 18pt; line-height:0.7;color:#DC143C;">Unfamiliar</p>
          </div>
          <div style="text-align:center; justify-content: space-evenly; margin: 10px 0 0 0;">
            <p style="font-weight: bold">2</p><p style="font-size: 18pt; line-height:0.5; ">Probably</p><p style="font-size: 18pt; line-height:0.7;color:#DC143C;">Unfamiliar</p>
          </div>
          <div style="text-align:center; justify-content: space-evenly; margin: 10px 0 0 0;">
            <p style="font-weight: bold">3</p><p style="font-size: 18pt; line-height:0.5; ">Maybe</p><p style="font-size: 18pt; line-height:0.7;color:#DC143C;">Unfamiliar</p>
          </div>
          <div style="text-align:center; justify-content: space-evenly; margin: 10px 0 0 0;">
            <p style="font-weight: bold">4</p><p style="font-size: 18pt; line-height:0.5; ">Maybe</p><p style="font-size: 18pt; line-height:0.7;color:#0073E6;">Familiar</p>
          </div>
          <div style="text-align:center; justify-content: space-evenly; margin: 10px 0 0 0;">
            <p style="font-weight: bold">5</p><p style="font-size: 18pt; line-height:0.5; ">Probably</p><p style="font-size: 18pt; line-height:0.7;color:#0073E6;">Familiar</p>
          </div>
          <div style="text-align:center; justify-content: space-evenly; margin: 10px 0 0 0;">
            <p style="font-weight: bold">6</p><p style="font-size: 18pt; line-height:0.5; ">Definitely</p><p style="font-size: 18pt; line-height:0.7;color:#0073E6;">Familiar</p>
          </div>
        </div>`,
        choices: ['1', '2', '3', '4', '5', '6'],
        data: { question_type: 'recognition', image, correct_answers: recogAnswers },
        trial_duration: null,
        on_finish(data) {
          // Score the keyboard response using confidence rating, where 1-3 is new and 7-9 is old
          data.correct = recogAnswers.includes(data.response);
          data.participant_response = data.response;
        },
      };
    }

    function sequenceRecognitionTest() {
      return shuffle([
        ...lureImages.map((image) => makeRecognitionQuestion(image, ['1', '2', '3'])),
        ...allImages.map((image) => makeRecognitionQuestion(image, ['4', '5', '6'])),
      ]);
    }

    function createRecallQuestion(image, nameGuesses, nameAnswer, behaviorAnswer, name, gender, race, condition, behaviorType) {
      return [
        {
          type: jsPsychHtmlKeyboardResponse,
          stimulus: "What's their name?",
          trial_duration: 700,
          choices: 'NO_KEYS',
        },
        {
          type: jsPsychHtmlKeyboardResponse,
          // https://flexboxfroggy.com/
          stimulus: `
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <!-- Image -->
            <img src="${image}" alt="Recall Image" style="width: 700px; margin: 0;">
            <!-- Names -->
            <div style ="line-height:2; text-align: left; font-size:35px">
              ${nameGuesses.map((name, i) => `<p>${i + 1}. ${name}</p>`).join('')}
            </div>
          </div>`,
          choices: ['1', '2', '3', '4', '5'],
          data: { question_type: 'recall', image, name, gender, race, condition, nameGuesses, nameAnswer },
          trial_duration: null,
          on_finish(data) {
            // Score the keyboard response as correct or incorrect.
            data.correct = jsPsych.pluginAPI.compareKeys(data.response, nameAnswer);
          },
        },
        {
          type: jsPsychHtmlKeyboardResponse,
          stimulus: 'What type of behavior is associated with this person?',
          trial_duration: null,
          choices: 'NO_KEYS',
        },
        {
          type: jsPsychImageKeyboardResponse,
          //stimulus: image,
          stimulus_width: 0,
          stimulus: `
          <div style="display: flex; justify-content: space-between; align-items: right;">
            <!-- Image -->
            <img src="${image}" alt="Recall Image" style="width: 700px; flex-shrink: 0;; margin: 0 0 0 0;">
            <!-- Names -->
            <div style="line-height:2;text-align:left; font-size:35px">
              <p>1.  Positive</p>
              <p>2.  Negative</p>
              <p>3.  No behavior</p>
            </div>
          </div>`,
          choices: ['1', '2', '3'],
          data: { question_type: 'behavior', image, behaviorType, behaviorAnswer },
          trial_duration: null,
          on_finish(data) {
            // Determine the correct response based on `behaviorType`
            data.correct = jsPsych.pluginAPI.compareKeys(data.response, behaviorAnswer);
          },
        },
      ];
    }

    function pickRandomNameWithCriteria(predicate) {
      const results = identifies.filter(predicate);

      const identity = results[Math.floor(Math.random() * results.length)];

      return identity.name;

    }

    function sequenceNameRecallTest() {
      const recall = shuffle(
        identifies.map(({ condition, name, image, behavior, race, gender, behaviorType }) => {
          let nameGuesses = [name];

          if (condition === 'control') {
            //if the ID is in control condition
            nameGuesses.push(
              pickRandomNameWithCriteria(
                //option 1. ID from control condition, same gender, same race
                (identity) =>
                  identity.race === race && identity.gender === gender && identity.condition === condition && identity.name !== name
              ),
              pickRandomNameWithCriteria(
                //option 2. ID from control condition, same gender, different race
                (identity) => identity.race !== race && identity.gender === gender && identity.condition === condition
              ),
              pickRandomNameWithCriteria(
                //option 3. ID from a different condition, same race
                (identity) => identity.race === race && identity.gender === gender && identity.condition !== condition
              )
            );
          } else {
            //if ID is from condition 1 or 2 (face-first or bio-first conditions)

            nameGuesses.push(
              pickRandomNameWithCriteria(
                //option 1. same race, gender, same condition, different behavior
                (identity) =>
                  identity.race === race &&
                  identity.gender === gender &&
                  identity.condition === condition &&
                  identity.behaviorType !== behaviorType
              ),
              pickRandomNameWithCriteria(
                //option 2. same race, gender, different condition, same behavior
                (identity) =>
                  identity.race === race &&
                  identity.gender === gender &&
                  identity.behaviorType === behaviorType &&
                  identity.condition !== condition
              ),
              pickRandomNameWithCriteria(
                //option 3. same race, gender, but control condition
                (identity) => identity.race === race && identity.gender === gender && identity.condition === 'control'
              )
            );
          }

          nameGuesses = shuffle(nameGuesses);
          const nameAnswer = nameGuesses.findIndex((guess) => guess === name) + 1;
          const behaviorAnswer = (() => {
            switch (behaviorType) {
              case 'positive':
                return '1';
              case 'negative':
                return '2';
              default:
                return '3';
            }
          })();

          return createRecallQuestion(
            image,
            nameGuesses,
            nameAnswer.toString(),
            behaviorAnswer.toString(),
            name,
            gender,
            race,
            condition,
            behaviorType
          );
        })
      );
      console.log(recall.flat());
      return recall;
    }

    const timeline = [
      {
        type: jsPsychPreload,
        // paths of images to load.
        images: [...allImages, ...lureImages],
      },
      {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: FirstInstruction,
      },
      //PracticeTrial_Learning(),
      ...sequenceLearningPhase(),
      {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: 'You will now watch a short video. Press any key to start.',
      },
      {
        type: jsPsychVideoKeyboardResponse,
        stimulus: ['video.mp4'],
        width: document.body.clientWidth,
        choices: 'NO_KEYS',
        trial_ends_after_video: true,
      },
      {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: `<p>Now, you will take a 2-part memory test.<p/>
          <p>Please wait for the experimenter instructions.<p/>
          <p>When prompted, press "1" to begin the first memory test.<p/>`,
        choices: '1',
      },
      //PracticeTrial_Recog(),
      ...sequenceRecognitionTest(),
      {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: `<p>Now, you will take the second part of the memory test.<p/>
          <p>Please wait for the experimenter instructions.<p/>
          <p>When prompted, press "1" to begin the second memory test.<p/>`,
        choices: '1',
      },
      //...createPracticeTrial_Recall(),
      ...sequenceNameRecallTest(),
      {
        type: jsPsychHtmlKeyboardResponse,
        stimulus() {
          const data = jsPsych.data.get();

          const recognition = data.filter({ question_type: 'recognition' });
          const recognitionPercent = (100 * recognition.filter({ correct: true }).count()) / recognition.count();

          const recall = data.filter({ question_type: 'recall' });
          const recallPercent = (100 * recall.filter({ correct: true }).count()) / recall.count();

          return `
          <p>You have completed the experiment. Thank you for your participation.</p>
          <p>Your recognition score is ${Math.round(recognitionPercent)}%.</p>
          <p>Your recall score is ${Math.round(recallPercent)}%.</p>
          <p> Press any key to exit the study.</p>
          `;
        },
      },
    ];

    jsPsych.run(timeline).then(() => {
      // this code runs when the timeline finishes
      downloadCSV('trial_result.csv', jsPsych.data.get().csv());
    });

    function downloadCSV(filename, table) {
      const link = document.createElement('a');
      link.href = encodeURI(`data:text/csv;charset=utf-8,${table}`);
      link.setAttribute('download', filename);
      link.style.display = 'none';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }
  </script>
</html>
